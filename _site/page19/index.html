<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Curtis Larson's Blog &middot; A lot of software talk.
    
  </title>

  
  

  <!-- CSS -->
  <link rel="stylesheet" href="/blog/public/css/poole.css">
  <link rel="stylesheet" href="/blog/public/css/syntax.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/blog/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico?v=2">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="Curtis Larson's Blog" href="/blog/atom.xml">

<!-- Mailchimp -->
  <link href="//cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
  <style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
       We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
  </style>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61702644-1', 'auto');
  ga('send', 'pageview');

</script>
  <script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/signup-forms/popup/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script><script type="text/javascript">require(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us11.list-manage.com","uuid":"1c8750215658512459a679f1e","lid":"29a072ab9b"}) })</script>
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/blog/" title="Blog">Curtis Larson's Blog</a>
           &nbsp;&nbsp;&nbsp;<small><a href="/">Main Site</a></small>
           &nbsp;&nbsp;&nbsp;<small><a href="/#portfolio">Portfolio</a></small>
          
           &nbsp;&nbsp;&nbsp;
           <small><a href="/blog/archive">Archive</a></small>
          
           &nbsp;&nbsp;&nbsp;
           <small><a href="/blog/atom.xml">Feed</a></small>
          
        </h3>
      </header>

      <main>
        <div class="posts">
  
  <article class="post">
    <h1 class="post-title">
      <a href="/blog/2015/07/30/meteor-send-template-emails-from-server-mailgun/">
        Meteor - Send Template Emails from the Server with Mailgun
      </a>
    </h1>

    <time datetime="2015-07-30T00:00:00-07:00" class="post-date">30 Jul 2015</time>

    <h2 id="introduction">Introduction</h2>

<p>In this tutorial I will show you how I have been sending template emails from the server with Mailgun. This is very useful if you want to send transactional or newsletter emails using a pre existing template, but you also want to dynamically populate the email with data from one of your Collections. The full code for this tutorial is available <a href="https://github.com/quackware/meteor-template-email">on my GitHub page</a>. If you have any questions please leave them in the comments!</p>

<h2 id="dependencies">Dependencies</h2>

<p>This tutorial requires the following dependencies (which will be auto downloaded if you clone the tutorial directly):</p>

<pre><code>iron:router
meteorhacks:npm
meteorhacks:ssr
</code></pre>

<p>Additionally you need to specify the following <code>meteorhacks:npm</code> dependency in a <code>package.json</code> file in your root directory:</p>

<pre><code>{
    "mailgun": "0.5.0"
}
</code></pre>

<h2 id="the-email-template">The Email Template</h2>

<p>For this tutorial I chose a basic email template (modified slightly for Meteor specific stuff) from the mailgun website. It is <strong>IMPORTANT</strong> that you put the template file in the <code>private/</code> directory of your project so that it can be accessed by <code>Assets.getText</code> on the server. I created the following file and placed it at <code>private/email-template.html</code>. Note the placeholders <code>mainTitle</code>, <code>tasks</code>, <code>task.title</code>, <code>task.url</code>, and <code>unsubscribe</code>. You will see how we will replace those placeholders with data from our collection later.</p>

<script src="https://gist.github.com/quackware/341cd73d196236f78b31.js"></script>

<h2 id="startup-code">Startup Code</h2>

<p>Now that we have our email template, we need to add some code to our server that is run on startup. I created a file called <code>startup.js</code> that will setup our template rendering system and setup our mailgun settings. The code can be seen below:</p>

<script src="https://gist.github.com/quackware/4f30b6007e89a45766b9.js"></script>

<p>Notice the creation of a <code>templates</code> array, which we push a single name and path to. The name is used when we want to reference a specific template when we send an email and the path references the relative location of the template html file to the <code>private/</code> directory. This template array is passed to a <code>EmailGenerator</code> object which we will implement in the next section. Another important thing to note is the various <code>Meteor.settings</code> variables I use in setting up my stmp <code>MAIL_URL</code>. These variables are read from a <code>settings.json</code> file that is loaded when you start meteor like so:</p>

<pre><code>meteor --settings settings.json
</code></pre>

<p>An example settings.json file for this tutorial would look something like this:</p>

<script src="https://gist.github.com/quackware/b70c9cf3c43fa0e01c13.js"></script>

<h2 id="mailgun">Mailgun</h2>

<p>The mailgun code is composed of a single <code>Meteor.method</code> that takes in basic email information and forwards it to the mailgun api we imported using <code>meteorhacks:npm</code>.</p>

<script src="https://gist.github.com/quackware/41cd6ba173d14a66557a.js"></script>

<p>Note that we use <code>sendRaw</code> here to take advantage of html emails, which requires us to format the rest of the email body manually.</p>

<h2 id="emailgenerator">EmailGenerator</h2>

<p>The <code>EmailGenerator</code> object contains two simple methods, one we saw above that compiles each template html file using <code>meteorhacks:ssr</code>, and another that generates the html from the compiled template. You can see the code for the <code>EmailGenerator</code> below:</p>

<script src="https://gist.github.com/quackware/820b7cc9f7f5f7ee24ec.js"></script>

<p>A few important things to note is the <code>templateName</code> argument of <code>generateHtml</code> which is used to referene the template we passed in with <code>addTemplates</code>, and also the <code>data</code> parameter of <code>generateHtml</code>. The <code>data</code> parameter is what will populate the various handlebar templates in our <code>email-templates.html</code> file. This data will come from our Meteor collection we set up in the next section.</p>

<h2 id="server-code">Server Code</h2>

<p>The server code is composed of two very basic <code>Meteor.methods</code>: <code>addTask</code> and <code>sendEmail</code>. Both of these methods will be called from the client code that we implement in the next section.</p>

<script src="https://gist.github.com/quackware/1f06550d64a7770a8fad.js"></script>

<p><code>addTask</code> does exactly what it’s name implies, adds a task composed of a title and url to a Mongo.collection we created with</p>

<pre><code>Tasks = new Mongo.Collection("tasks");
</code></pre>

<p>specified in a seperate javascript file (You can add that line anywhere in the server code). <code>sendEmail</code> is slightly more complicated, but basically acts as the glue between all our previously implemented code. It pulls all the tasks from the database, creates that data object that we then pass to <code>EmailGenerator.generateHtml</code>, and calls the <code>sendMailGunEmail</code> method with the generated email html which forwards the email to our mailgun api.</p>

<h2 id="client-code">Client Code</h2>

<p>Finally we need to create some basic client code where the user can enter a title and a url for a “task”. This task data will be sent to the server where we will insert it into the <code>Tasks</code> collection. We can then pull data from this <code>Tasks</code> collection and use it to populate our email template that we will create.</p>

<p>In addition to adding tasks, we will let the user be able to click a button to send an email. This code will just perform a basic <code>Meteor.call</code> which will call into our template generating and email sending code on the server. You can see the two files, <code>index.html</code> and <code>index.js</code> below:</p>

<script src="https://gist.github.com/quackware/831b9cb8df0e9c849adb.js"></script>

<script src="https://gist.github.com/quackware/57643c6fe549eab61695.js"></script>

<h2 id="conclusion">Conclusion</h2>

<p>Hopefully this helps our anyone that was interested in how to send template emails from the server with mailgun. Again the full code for this tutorial is available <a href="https://github.com/quackware/meteor-template-email">on my GitHub page</a>. If you have any questions please leave them in the comments!</p>

    
    <hr/>
    
    <span>
      <a href="http://www.curtismlarson.com" target="_blank">Curtis Larson</a> is a LA based freelance software developer. <a href="https://twitter.com/quackware" target="_blank">Follow him on Twitter</a> or <a href="mailto:curtis@curtismlarson.com" target="_blank">send him an email</a> if your looking for a talented developer.
    </span>
    
    <div id="mc_embed_signup">
<form action="//curtismlarson.us11.list-manage.com/subscribe/post?u=1c8750215658512459a679f1e&amp;id=29a072ab9b" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
  <label for="mce-EMAIL">Subscribe to our mailing list</label>
  <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;"><input type="text" name="b_1c8750215658512459a679f1e_29a072ab9b" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>
  </article>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/blog/page20">Older</a>
  
  
    
      <a class="pagination-item newer" href="/blog/page18">Newer</a>
    
  
</div>

      </main>
      <footer class="footer">
        <small>
          &copy; <time datetime="2018-10-03T08:50:26-07:00">2018</time> Curtis Larson. All rights reserved.
        </small>
      </footer>
    </div>

  </body>
</html>
